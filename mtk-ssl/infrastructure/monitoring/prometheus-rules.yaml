# SSL Prometheus Alerting Rules
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: ssl-alerts
  namespace: monitoring
  labels:
    app: ssl
    prometheus: main
spec:
  groups:
    # ============================================
    # Application Alerts
    # ============================================
    - name: ssl.application
      rules:
        - alert: HighErrorRate
          expr: |
            sum(rate(http_requests_total{status=~"5.."}[5m])) by (service)
            / sum(rate(http_requests_total[5m])) by (service) > 0.01
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "High error rate on {{ $labels.service }}"
            description: "Error rate is {{ $value | humanizePercentage }} on {{ $labels.service }}"
            runbook_url: "https://docs.ssl.cricket/runbooks/high-error-rate"

        - alert: HighLatency
          expr: |
            histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)) > 2
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High latency on {{ $labels.service }}"
            description: "P95 latency is {{ $value }}s on {{ $labels.service }}"

        - alert: ServiceDown
          expr: up{job=~"ssl-.*"} == 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "Service {{ $labels.job }} is down"
            description: "{{ $labels.instance }} of {{ $labels.job }} has been down for more than 1 minute"

    # ============================================
    # Scoring Service Alerts
    # ============================================
    - name: ssl.scoring
      rules:
        - alert: ScoringWebSocketConnections
          expr: ssl_websocket_connections > 10000
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High WebSocket connections"
            description: "{{ $value }} WebSocket connections on scoring service"

        - alert: ScoringEventLag
          expr: ssl_scoring_event_processing_lag_seconds > 5
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "Scoring event processing lag"
            description: "Events are delayed by {{ $value }}s"

    # ============================================
    # Database Alerts
    # ============================================
    - name: ssl.database
      rules:
        - alert: DatabaseConnectionPoolExhausted
          expr: |
            pg_stat_activity_count / pg_settings_max_connections > 0.9
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Database connection pool near exhaustion"
            description: "Connection pool usage is at {{ $value | humanizePercentage }}"

        - alert: DatabaseReplicationLag
          expr: pg_replication_lag > 30
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Database replication lag"
            description: "Replication lag is {{ $value }}s"

        - alert: RedisMemoryHigh
          expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.85
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Redis memory usage high"
            description: "Redis memory usage is at {{ $value | humanizePercentage }}"

    # ============================================
    # Kafka Alerts
    # ============================================
    - name: ssl.kafka
      rules:
        - alert: KafkaConsumerLag
          expr: kafka_consumer_group_lag > 10000
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Kafka consumer lag high"
            description: "Consumer group {{ $labels.group }} has lag of {{ $value }}"

        - alert: KafkaBrokerDown
          expr: kafka_brokers < 3
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Kafka broker down"
            description: "Only {{ $value }} brokers are available"

    # ============================================
    # Kubernetes Alerts
    # ============================================
    - name: ssl.kubernetes
      rules:
        - alert: PodCrashLooping
          expr: |
            increase(kube_pod_container_status_restarts_total{namespace=~"ssl-.*"}[1h]) > 3
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Pod {{ $labels.pod }} is crash looping"
            description: "{{ $labels.pod }} in {{ $labels.namespace }} has restarted {{ $value }} times"

        - alert: PodNotReady
          expr: |
            kube_pod_status_ready{condition="true", namespace=~"ssl-.*"} == 0
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Pod {{ $labels.pod }} is not ready"

        - alert: HighMemoryUsage
          expr: |
            container_memory_usage_bytes{namespace=~"ssl-.*"} 
            / container_spec_memory_limit_bytes{namespace=~"ssl-.*"} > 0.9
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High memory usage on {{ $labels.pod }}"
            description: "Memory usage is at {{ $value | humanizePercentage }}"

        - alert: HighCPUUsage
          expr: |
            rate(container_cpu_usage_seconds_total{namespace=~"ssl-.*"}[5m]) 
            / container_spec_cpu_quota{namespace=~"ssl-.*"} * 100000 > 0.9
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage on {{ $labels.pod }}"
